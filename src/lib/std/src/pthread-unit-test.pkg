## pthread-unit-test.pkg
#
# Unit/regression test functionality for
#
#    src/lib/std/src/pthread.pkg
#
# (Multiple posix threads sharing the Mythryl
# heap and executing Mythryl code.)

# Compiled by:
#     src/lib/test/unit-tests.lib

# Run by:
#     src/lib/test/all-unit-tests.pkg

package pthread_unit_test {
    #
    include unit_test;							# unit_test			is from   src/lib/src/unit-test.pkg

    my name = "src/lib/std/src/pthread-unit-test.pkg";

    fun verify_that_basic_spawn_and_join_are_working ()
	=
	{   foo = REF 0;
	    #
	    fun subthread_fn ()
		=
		{   makelib::scripting_globals::sleep 0.01;		# Give main thread a good chance to finish early if join_pthread is totally broken.
		    #
		    foo := 1;						# Give main thread visible evidence that we've run.
		    #
		    pthread::pthread_exit ();				# Die.
		};

	    subthread = pthread::spawn_pthread  subthread_fn;		# Spawn a subthread.
	    #
	    pthread::join_pthread  subthread;				# Wait for subthread to exit.
	    #
	    assert (*foo == 1);						# Verify that subthread did what we expected.
	};


    fun verify_that_basic_mutex_stuff_is_working ()
	=
	{   foo = REF 0; 
	    #
	    mutex = pthread::make_mutex (); 
	    pthread::set_up_mutex (mutex, NULL); 
	    pthread::acquire_mutex mutex; 

	    fun subthread_fn () 
		= 
		{   pthread::acquire_mutex mutex; 
		    # 
		    foo := 1; 
		    # 
		    pthread::release_mutex mutex; 
		    # 
		    pthread::pthread_exit (); 
		}; 

	    pthread =  pthread::spawn_pthread  subthread_fn; 

	    makelib::scripting_globals::sleep 0.01; 			# Give child a chance to run if mutex does not block properly.

	    assert (*foo == 0);						# Verify that child has not run.

	    pthread::release_mutex mutex; 				# Unblock child.

	    pthread::join_pthread pthread; 				# Join child.

	    pthread::free_mutex mutex;

	    assert (*foo == 1);						# Verify that child has now run.
	};

    fun run ()
        =
        {   printf "\nDoing %s:\n" name;   
	    #
	    assert( pthread::get_pthread_id()  !=  0 );
		#
		# This is mostly just to verify that	src/c/lib/pthread/libmythryl-pthread.c
		# and					src/c/pthread/pthread-on-posix-threads.c
		# were compiled and linked into our
		# runtime executable.

	    verify_that_basic_spawn_and_join_are_working ();
	    verify_that_basic_mutex_stuff_is_working ();
	    #
            summarize_unit_tests  name;
	};
};

