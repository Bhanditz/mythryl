## core-prettyprinter.pkg
#
# Support for prettyprinting plain ascii text --
# a workhorse tool used by about eighty packages.
#
# Compare to:
#     src/lib/prettyprint/simple/simple-prettyprinter.pkg

# Compiled by:
#     src/lib/prettyprint/big/prettyprinting.lib



###            "The gods too are fond of a joke."
###
###                            -- Aristotle


api Core_Prettyprinter {
    #
    include Prettyprinter;							# Prettyprinter	is from   src/lib/prettyprint/big/src/prettyprinter.api
    #
    with_standard_prettyprinter:    Prettyprinter_Output_Stream
			            -> List( Prettyprinter_Args )
				    -> (Prettyprinter -> Void)
				    -> Void
				    ;

    prettyprint_to_string:	    List( Prettyprinter_Args )
				    -> (Prettyprinter -> Void)
				    -> String
				    ;
};



package   core_prettyprinter
: (weak)  Core_Prettyprinter
{
    Prettyprinter_Output_Stream
        =
        { consumer:   String -> Void,
	  flush:      Void -> Void,
	  close:      Void -> Void
        };

    package out {
	#
	Prettyprinter_Output_Stream = Prettyprinter_Output_Stream;
	Textstyle  = Void;

	fun same_textstyle _    = TRUE;
	fun push_textstyle _    = ();
	fun pop_textstyle _     = ();
	fun default_textstyle _ = ();

	fun depth _ = NULL;
	fun text_width _ = NULL;

	fun space ( { consumer, flush, close }, n)
	    =
	    consumer (number_string::pad_left ' ' n "");

	fun newline  { consumer, flush, close }     =  consumer "\n";
	fun string ( { consumer, flush, close }, s) =  consumer s;
	fun char   ( { consumer, flush, close }, c) =  consumer (str c);
	fun flush    { consumer, flush, close }     =  flush();
	fun close    { consumer, flush, close }     =  close();
    };

    package pp
        =
        prettyprinter_g (								# prettyprinter_g		def in    src/lib/prettyprint/big/src/prettyprinter-g.pkg
	    #
            package ss  =  unstyled_string;						# unstyled_string		is from   src/lib/prettyprint/big/src/unstyled-string.pkg
            package out =  out;
        );

    include pp;

    fun with_standard_prettyprinter  output_stream  pp_args  (f: pp::Prettyprinter -> Void)	# Compared to the make_standard_prettyprinter() approach, this
        =											# approach makes it harder to forget to flush+close the prettyprinter.
	{   pp =   pp::make_prettyprinter  output_stream  pp_args;
	    #
            f pp;

	    pp::close_prettyprinter  pp;
	};

    fun prettyprint_to_string   pp_args  prettyprint_fn
        =
	{   l =   REF ([] : List( String ));
	    #
	    fun attach s =    l :=  s ! *l;

	    output_stream
		=
		{ consumer => attach,
		  flush =>  fn()=(),
		  close =>  fn()=()
		};

            with_standard_prettyprinter
                output_stream  pp_args
	        prettyprint_fn;

	    string::cat (list::reverse *l);
	};
};											# package prettyprint 


##########################################################################
#   The following is support for outline-minor-mode in emacs.		 #
#  ^C @ ^T hides all Text. (Leaves all headings.)			 #
#  ^C @ ^A shows All of file.						 #
#  ^C @ ^Q Quickfolds entire file. (Leaves only top-level headings.)	 #
#  ^C @ ^I shows Immediate children of node.				 #
#  ^C @ ^S Shows all of a node.						 #
#  ^C @ ^D hiDes all of a node.						 #
#  ^HFoutline-mode gives more details.					 #
#  (Or do ^HI and read emacs:outline mode.)				 #
#									 #
# Local variables:							 #
# mode: outline-minor							 #
# outline-regexp: "[{ \t]*\\(fun \\)"			 		 #
# End:									 #
##########################################################################


## COPYRIGHT (c) 2003 The SML/NJ Fellowship
## Subsequent changes by Jeff Prothero Copyright (c) 2010-2013,
## released per terms of SMLNJ-COPYRIGHT.
