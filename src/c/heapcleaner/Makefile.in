#
# the makefile for the garbage collector and heap I/O library
#

AR =		ar
ARFLAGS =	rcv
RANLIB =	ranlib

LIB =		libmythryl-cleaner.a
MULTICORE_LIB =	libmythryl-pthread-cleaning-stuff.a

CLEANER_OBJS =					\
		heapcleaner-initialization.o		\
		call-heapcleaner.o			\
		clean-agegroup0.o			\
		clean-n-agegroups.o			\
		heapcleaner-stuff.o			\
		hugechunk.o				\
		make-strings-and-vectors-etc.o		\
		get-chunk-age.o				\
		make-package-literals-via-bytecode-interpreter.o			\
		tuple-ops.o				\
		$(CHECK_HEAP)

HEAP_IO_OBJS =	import-heap.o				\
		export-heap.o				\
		datastructure-unpickler.o				\
		datastructure-pickler.o				\
		datastructure-pickler-cleaner.o		\
		import-heap-stuff.o				\
		export-heap-stuff.o			\
		writer.o				\
		mem-writer.o				\
		address-hashtable.o			\
		mythryl-callable-cfun-hashtable.o

MULTICORE_CLEANING_OBJS =	pthread-cleaning-stuff.o

OBJS =		$(CLEANER_OBJS) $(HEAP_IO_OBJS)
MULTICORE_OBJS =	$(OBJS) $(MULTICORE_CLEANING_OBJS)

VERSION =	v-dummy

OBJS_DIR =	../o
INC_DIR =	../h
INCLUDES =	-I$(OBJS_DIR) -I$(INC_DIR)


$(LIB) :	$(VERSION) $(OBJS)
	@rm -rf $(LIB)
	$(AR) $(ARFLAGS) $(LIB) $(OBJS)
	$(RANLIB) $(LIB)

$(MULTICORE_LIB) :	$(VERSION) $(MULTICORE_OBJS)
	@rm -rf $(MULTICORE_LIB)
	$(AR) $(ARFLAGS) $(MULTICORE_LIB) $(MULTICORE_OBJS)
	$(RANLIB) $(MULTICORE_LIB)

$(VERSION) :
	echo "$(VERSION)" > $(VERSION)

#
# GC chunks
#
heapcleaner-initialization.o:							\
		heapcleaner-initialization.c					\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/runtime-configuration.h				\
		$(INC_DIR)/task.h						\
		$(INC_DIR)/runtime-values.h					\
		$(INC_DIR)/bigcounter.h						\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/get-multipage-ram-region-from-os.h			\
		$(INC_DIR)/runtime-pthread.h					\
		$(INC_DIR)/heap.h						\
		$(INC_DIR)/heapcleaner-statistics-2.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) heapcleaner-initialization.c

call-heapcleaner.o:	call-heapcleaner.c					\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/runtime-configuration.h				\
		$(INC_DIR)/task.h						\
		$(INC_DIR)/runtime-values.h					\
		$(INC_DIR)/bigcounter.h						\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/get-multipage-ram-region-from-os.h			\
		$(INC_DIR)/runtime-pthread.h					\
		$(INC_DIR)/heap.h						\
		$(INC_DIR)/heapcleaner-statistics-2.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) call-heapcleaner.c

clean-agegroup0.o:	clean-agegroup0.c					\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/task.h						\
		$(INC_DIR)/runtime-values.h					\
		$(INC_DIR)/make-strings-and-vectors-etc.h			\
		$(INC_DIR)/heap-tags.h						\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/runtime-globals.h					\
		$(INC_DIR)/heap.h						\
		$(INC_DIR)/coarse-inter-agegroup-pointers-map.h			\
		copy-loop.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) clean-agegroup0.c

clean-n-agegroups.o:	clean-n-agegroups.c					\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/runtime-configuration.h				\
		$(INC_DIR)/task.h						\
		$(INC_DIR)/runtime-values.h					\
		$(INC_DIR)/make-strings-and-vectors-etc.h			\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/heap-tags.h						\
		$(INC_DIR)/runtime-globals.h					\
		$(INC_DIR)/heap.h						\
		$(INC_DIR)/coarse-inter-agegroup-pointers-map.h			\
		copy-loop.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) clean-n-agegroups.c

heapcleaner-stuff.o:	heapcleaner-stuff.c					\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/runtime-configuration.h				\
		$(INC_DIR)/runtime-values.h					\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/get-multipage-ram-region-from-os.h			\
		$(INC_DIR)/heap.h						\
		$(INC_DIR)/coarse-inter-agegroup-pointers-map.h 
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) heapcleaner-stuff.c

hugechunk.o:	hugechunk.c							\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/get-multipage-ram-region-from-os.h			\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/heap.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) hugechunk.c

make-strings-and-vectors-etc.o:	make-strings-and-vectors-etc.c			\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/make-strings-and-vectors-etc.h			\
		$(INC_DIR)/runtime-configuration.h				\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/heap-tags.h						\
		$(INC_DIR)/heap.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) make-strings-and-vectors-etc.c

make-package-literals-via-bytecode-interpreter.o:			make-package-literals-via-bytecode-interpreter.c			\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/make-strings-and-vectors-etc.h			\
		$(INC_DIR)/heap-tags.h						\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/heap.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) make-package-literals-via-bytecode-interpreter.c

tuple-ops.o: 		tuple-ops.c						\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/make-strings-and-vectors-etc.h 			\
		$(INC_DIR)/heap-tags.h						\
		$(INC_DIR)/sibid.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) tuple-ops.c

get-chunk-age.o:	get-chunk-age.c						\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/runtime-values.h					\
		$(INC_DIR)/heapcleaner.h					\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/heap.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) get-chunk-age.c

check-heap.o:	check-heap.c							\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/heap.h						\
		$(INC_DIR)/coarse-inter-agegroup-pointers-map.h 
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) check-heap.c

heapcleaner-statistics.o: 	heapcleaner-statistics.c			\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h 					\
		heapcleaner-statistics.h 
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) heapcleaner-statistics.c

pthread-cleaning-stuff.o:		pthread-cleaning-stuff.c		\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/runtime-configuration.h				\
		$(INC_DIR)/task.h						\
		$(INC_DIR)/runtime-values.h					\
		$(INC_DIR)/bigcounter.h						\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/get-multipage-ram-region-from-os.h			\
		$(INC_DIR)/runtime-pthread.h					\
		$(INC_DIR)/heap.h						\
		$(INC_DIR)/heapcleaner-statistics-2.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) pthread-cleaning-stuff.c


#
# Heap I/O chunks
#
mythryl-callable-cfun-hashtable.o:		mythryl-callable-cfun-hashtable.c				\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/mythryl-callable-cfun-hashtable.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) mythryl-callable-cfun-hashtable.c

import-heap.o:	import-heap.c							\
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h $(INC_DIR)/runtime-configuration.h	\
		$(INC_DIR)/task.h $(INC_DIR)/mythryl-callable-cfun-hashtable.h			\
		$(INC_DIR)/flush-instruction-cache-system-dependent.h		\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/heap.h						\
		$(INC_DIR)/coarse-inter-agegroup-pointers-map.h			\
		writer.h							\
		runtime-heap-image.h						\
		address-hashtable.h						\
		import-heap-stuff.h

.c.o:		$< \
		$(OBJS_DIR)/sizes-of-some-c-types--autogenerated.h		\
		$(INC_DIR)/runtime-base.h					\
		$(INC_DIR)/runtime-configuration.h				\
		$(INC_DIR)/task.h						\
		$(INC_DIR)/mythryl-callable-cfun-hashtable.h					\
		$(INC_DIR)/sibid.h						\
		$(INC_DIR)/heap.h 						\
		writer.h							\
		runtime-heap-image.h						\
		address-hashtable.h						\
		import-heap-stuff.h
	$(CC) -c $(CFLAGS) $(DEFS) $(INCLUDES) $<

clean :
	@rm -f v-* *.o $(LIB) $(MULTICORE_LIB)

