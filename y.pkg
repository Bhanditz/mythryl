# y.pkg
#
# 2012-02-27 CrT:
#   This package is part of an attempt to track down a segfault bug
#   in the new posix-threads support in the Mythryl codebase.
#
# I run it by doing
#
#     linux%  gdb --args bin/mythryl-runtime-intel32 --shebang bin/mythryld
#     (gdb) run
#     eval:  make "y.lib";
#     eval:  y::run ();
#
# (See run history and additional comments at foot of file.)
#

package y {

    include int_red_black_map;					# int_red_black_map		is from   src/lib/src/int-red-black-map.pkg

    fun assert (bool_value, bool_string)
        =
	if (not bool_value)
	   #
	   printf "Assertion '%s' failed.\n" bool_string;
	   winix::process::exit 1;
	fi;


    # When debugging uncomment the following lines and
    # add more log_if calls as appropriate:
    #
#   file::set_logger_to (file::LOG_TO_FILE "xyzzy.log");
#   log_if = file::log_if file::compiler_logging;
#   log_if .{ "Top of script"; }; 

    loops = 5;				# Originally 100, then 1100.

    limit = 10 * 1000;			# Originally 100.

    fun subpthread_fn id ()
	=
	{
	    for (loop = 0; loop < loops; ++loop) {

printf "loop %d\n" loop;
		# Create a map by successive appends:
		#
		my test_map
		    =
		    for (m = empty, i = 0;  i < limit;  ++i; m) {

			m = set (m, i, i);
			assert (all_invariants_hold m,				"all_invariants_hold m");
			assert (not (is_empty m),				"not (is_empty m)");
			assert (the (first_val_else_null m) == 0,		"the (first_val_else_null m) == 0");
			assert (     vals_count m  == i+1,			"vals_count m  == i+1");

			assert (#1 (the (first_keyval_else_null m)) == 0,	"#1 (the (first_keyval_else_null m)) == 0");
			assert (#2 (the (first_keyval_else_null m)) == 0,	"#2 (the (first_keyval_else_null m)) == 0");

		    };

		# Check resulting map's contents:
		#
		for (i = 0;  i < limit;  ++i) {
		    #
		    assert ((the (get (test_map, i))) == i,			sprintf "(the (get (test_map, %d))) == %d" i i);
		};

		# Try removing at all possible positions in map:
		#
		for (map' = test_map, i = 0;   i < limit;   ++i) {

		    my (map'', value) = drop (map', i);

		    assert (all_invariants_hold map'',				"all_invariants_hold map''");
		};

		assert (is_empty empty,						"is_empty empty");
	    };

	    pthread::pthread_exit ();
	};	


    fun run ()
	=
	{
	    heap_debug::breakpoint_1 ();

	    subpthread0 = pthread::spawn_pthread  (subpthread_fn 0);
	    subpthread1 = pthread::spawn_pthread  (subpthread_fn 1);
	    subpthread2 = pthread::spawn_pthread  (subpthread_fn 2);
	    subpthread3 = pthread::spawn_pthread  (subpthread_fn 3);
	    subpthread4 = pthread::spawn_pthread  (subpthread_fn 4);
	    subpthread5 = pthread::spawn_pthread  (subpthread_fn 5);

	    heap_debug::check_agegroup0_overrun_tripwire_buffer "y: About to join subthread0";
	    print "y: About to join subthread0";

posix_1003_1b::sleep (time::from_float_seconds 300.0);

#		pthread::join_pthread  subpthread0;
#	    heap_debug::check_agegroup0_overrun_tripwire_buffer "y: Joined subthread0";
#	    print "y: Joined subthread0";

#		pthread::join_pthread  subpthread1;
#	    heap_debug::check_agegroup0_overrun_tripwire_buffer "y: Joined subthread1";
#	    print "y: Joined subthread1";

#		pthread::join_pthread  subpthread2;
#	    heap_debug::check_agegroup0_overrun_tripwire_buffer "y: Joined subthread2";
#	    print "y: Joined subthread2";

#		pthread::join_pthread  subpthread3;
#	    heap_debug::check_agegroup0_overrun_tripwire_buffer "y: Joined subthread3";
#	    print "y: Joined subthread3";

#		pthread::join_pthread  subpthread4;
#	    heap_debug::check_agegroup0_overrun_tripwire_buffer "y: Joined subthread4";
#	    print "y: Joined subthread4";

#		pthread::join_pthread  subpthread5;
#	    heap_debug::check_agegroup0_overrun_tripwire_buffer "y: Joined subthread5";
#	    print "y: Joined subthread5";
	};
};
#

#
# Crashing seems totally erratic at present.
# At one point we seemed to run to completion but segfault on exit.
# Recent runs:
#   1. Segfaulted after roughly 45 loops.
#   2. Segfaulted after 99 loops.
#   3. Stopped it after 169 loops.
#   4. Changed limit to 10, got
#           loop 9
#           loop 9
#           loop 9
#           loop 9
#           loop 9
#           loop 9
#           [Thread 0xafb9fb70 (LWP 27716) exited]
#           [Thread 0xb1b9fb70 (LWP 27712) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 27711) exited]
#           y: Joined subthread1
#           Program received signal SIGTRAP, Trace/breakpoint trap.
#           [Switching to Thread 0xb0b9fb70 (LWP 27714)]
#           0xadfc3261 in ?? ()
#           (gdb) 
#
#   5. Changed limit to 2, got
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 27730)]
#           [New Thread 0xb1b9fb70 (LWP 27731)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 27732)]
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 27733)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb039fb70 (LWP 27734)]
#           [New Thread 0xafb9fb70 (LWP 27735)]
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           [Thread 0xb239fb70 (LWP 27730) exited]
#           y: Joined subthread0
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb1b9fb70 (LWP 27731)]
#           0xb3419ac1 in ?? ()
#           (gdb) 
#
# 
#   6. Limit left at 2:
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 28291)]
#           [New Thread 0xb1b9fb70 (LWP 28292)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb139fb70 (LWP 28293)]
#           [New Thread 0xb0b9fb70 (LWP 28294)]
#           loop 0
#           [New Thread 0xb039fb70 (LWP 28295)]
#           loop 0
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 28296)]
#           loop 0
#           loop 0
#           y: About to join subthread0loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           [Thread 0xb0b9fb70 (LWP 28294) exited]
#           [Thread 0xb139fb70 (LWP 28293) exited]
#           [Thread 0xb1b9fb70 (LWP 28292) exited]
#           y: Joined subthread0y: Joined subthread1y: Joined subthread2y: Joined subthread3[Thread 0xb239fb70 (LWP 28291) exited]
#           Assertion failed.
#           y: Joined subthread4[Thread 0xb039fb70 (LWP 28295) exited]
#           [Thread 0xafb9fb70 (LWP 28296) exited]
#           
#           Program exited with code 01.
#
#   7. Added logic to identify failing assertions.
#      Problem failed to manifest on first run but
#      segv'd immediately upon restart:
#
#           [Thread 0xb0b9fb70 (LWP 17376) exited]
#           [Thread 0xafb9fb70 (LWP 17378) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 17373) exited]
#           y: Joined subthread1[Thread 0xb1b9fb70 (LWP 17374) exited]
#           [Thread 0xb039fb70 (LWP 17377) exited]
#           y: Joined subthread2y: Joined subthread3y: Joined subthread4[Thread 0xb139fb70 (LWP 17375) exited]
#           y: Joined subthread5
#           ()
#           
#           eval:  y::run();
#           [New Thread 0xafb9fb70 (LWP 17382)]
#           [New Thread 0xb039fb70 (LWP 17383)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 17385)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17386)]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb139fb70 (LWP 17386)]
#           0xae2034d6 in ?? ()
#
#   8. Ditto. But restarting may not be legitimate.
#
#   9. Changed 'loops' to 5.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17440)]
#           [New Thread 0xb1b9fb70 (LWP 17441)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17442)]
#           [New Thread 0xb0b9fb70 (LWP 17443)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb039fb70 (LWP 17444)]
#           [New Thread 0xafb9fb70 (LWP 17445)]
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           y: About to join subthread0loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb239fb70 (LWP 17440) exited]
#           y: Joined subthread0[Thread 0xafb9fb70 (LWP 17445) exited]
#           bin/mythryld: Fatal error:  bad chunk tag 27, chunk = 0xb4f75e14, tagword = 0xad565a6c   -- forward_agegroup0_chunk_to_agegroup1() in src/c/heapcleaner/heapclean-agegroup0.c
#           [Thread 0xb039fb70 (LWP 17444) exited]
#           [Thread 0xb139fb70 (LWP 17442) exited]
#           [Thread 0xb1b9fb70 (LWP 17441) exited]
#           [Thread 0xb0b9fb70 (LWP 17443) exited]
#           
#           Program exited with code 01.
#           (gdb) 
#
#
#   10.
#           eval:  y::run ();
#           [New Thread 0xb239fb70 (LWP 17456)]
#           [New Thread 0xb1b9fb70 (LWP 17458)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17459)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 17460)]
#           [New Thread 0xb039fb70 (LWP 17461)]
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 17462)]
#           loop 0
#           loop 0
#           y: About to join subthread0y: Abouloop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb239fb70 (LWP 17456) exited]
#           y: Joined subthread0bin/mythryld: Fatal error:  bad chunk tag 17, chunk = 0xb502940c, tagword = 0xad555fc4   -- forward_agegroup0_chunk_to_agegroup1() in src/c/heapcleaner/heapclean-agegroup0.c
#           [Thread 0xafb9fb70 (LWP 17462) exited]
#           [Thread 0xb0b9fb70 (LWP 17460) exited]
#           [Thread 0xb139fb70 (LWP 17459) exited]
#           [Thread 0xb039fb70 (LWP 17461) exited]
#           [Thread 0xb1b9fb70 (LWP 17458) exited]
#           
#           Program exited with code 01.
#           (gdb) 
#
#   11.
#           eval:  y::run ();
#           [New Thread 0xb239fb70 (LWP 17508)]
#           [New Thread 0xb1b9fb70 (LWP 17509)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17510)]
#           [New Thread 0xb0b9fb70 (LWP 17511)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb039fb70 (LWP 17512)]
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 17513)]
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb239fb70 (LWP 17508) exited]
#           y: Joined subthread0[Thread 0xb039fb70 (LWP 17512) exited]
#           Assertion 'all_invariants_hold map''' failed.
#           [Thread 0xb0b9fb70 (LWP 17511) exited]
#           [Thread 0xafb9fb70 (LWP 17513) exited]
#           [Thread 0xb139fb70 (LWP 17510) exited]
#           [Thread 0xb1b9fb70 (LWP 17509) exited]
#           
#           Program exited with code 01.
#
#
#
#   12.
#           eval:  y::run ();
#           [New Thread 0xb239fb70 (LWP 17530)]
#           [New Thread 0xb1b9fb70 (LWP 17531)]
#           [New Thread 0xb139fb70 (LWP 17532)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 17533)]
#           [New Thread 0xb039fb70 (LWP 17534)]
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 17535)]
#           loop 0
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb239fb70 (LWP 17530) exited]
#           y: Joined subthread0bin/mythryld: Fatal error:  bad chunk tag 23, chunk = 0xb4fafd54, tagword = 0xad4784dc   -- forward_agegroup0_chunk_to_agegroup1() in src/c/heapcleaner/heapclean-agegroup0.c
#           [Thread 0xafb9fb70 (LWP 17535) exited]
#           [Thread 0xb039fb70 (LWP 17534) exited]
#           [Thread 0xb139fb70 (LWP 17532) exited]
#           [Thread 0xb1b9fb70 (LWP 17531) exited]
#           [Thread 0xb0b9fb70 (LWP 17533) exited]
#           
#           Program exited with code 01.
#           (gdb)
#
#
#   13. Dropped 'limit' from 10,000 to 1000.  No failure.
#   14. Ditto. No failure.
#   15. Ditto.  No failure.
#   16. Increased 'limit' from 1000 back to 10,000.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17597)]
#           [New Thread 0xb1b9fb70 (LWP 17598)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17599)]
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 17600)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb039fb70 (LWP 17601)]
#           loop 0
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 17602)]
#           loop 0
#           y: About to join subthread0loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb239fb70 (LWP 17597) exited]
#           y: Joined subthread0
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb0b9fb70 (LWP 17600)]
#           0xad4a7c05 in ?? ()
#           (gdb)
#
#
#   17. Commented out subthreads 2,3,4,5.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17618)]
#           [New Thread 0xb1b9fb70 (LWP 17619)]
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           [Thread 0xb1b9fb70 (LWP 17619) exited]
#           y: Joined subthread0y: Joined subthread1[Thread 0xb239fb70 (LWP 17618) exited]
#
#   18. No change in code, no change in result.
#   19. Restored thread 2.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17649)]
#           [New Thread 0xb1b9fb70 (LWP 17650)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17651)]
#           y: About to join subthread0loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb239fb70 (LWP 17649) exited]
#           y: Joined subthread0[Thread 0xb139fb70 (LWP 17651) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb1b9fb70 (LWP 17650)]
#           0x00000202 in ?? ()
#
#   20. No change no crash.
#   21. No change no crash.
#   22. Restored thread3.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17762)]
#           [New Thread 0xb1b9fb70 (LWP 17763)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17764)]
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 17765)]
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           y: About to join subthread0loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb1b9fb70 (LWP 17763) exited]
#           y: Joined subthread0y: Joined subthread1[Thread 0xb239fb70 (LWP 17762) exited]
#           [Thread 0xb0b9fb70 (LWP 17765) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb139fb70 (LWP 17764)]
#           0xaa9100a4 in ?? ()
#           (gdb)
#
#   22. No change
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17775)]
#           [New Thread 0xb1b9fb70 (LWP 17776)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17777)]
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 17778)]
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb139fb70 (LWP 17777) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 17775) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb0b9fb70 (LWP 17778)]
#           0xaa9100a4 in ?? ()
#           (gdb)
#
#   23. No change, no failure.
#   24. No change, no failure.
#   25. No change, no failure.
#   26. No change, no failure.
#   27. No change, no failure.
#   28. No change, no failure.
#   29. No change, no failure.
#   30. No change
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17899)]
#           [New Thread 0xb1b9fb70 (LWP 17900)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17901)]
#           [New Thread 0xb0b9fb70 (LWP 17902)]
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb0b9fb70 (LWP 17902) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 17899) exited]
#           Assertion 'all_invariants_hold map''' failed.
#           [Thread 0xb139fb70 (LWP 17901) exited]
#           [Thread 0xb1b9fb70 (LWP 17900) exited]
#           
#           Program exited with code 01.
#
#   31.  No change
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17922)]
#           [New Thread 0xb1b9fb70 (LWP 17923)]
#           [New Thread 0xb139fb70 (LWP 17924)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 17925)]
#           y: About to join subthread0y: About to join subthread0loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb139fb70 (LWP 17924) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 17922) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb0b9fb70 (LWP 17925)]
#           0xaa9000a4 in ?? ()
#
#   32.  No change no error.
#   33.  No change no error.
#   34.  Removed thread3 again.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 17973)]
#           [New Thread 0xb1b9fb70 (LWP 17974)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 17975)]
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 17973) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb1b9fb70 (LWP 17974)]
#           0xab150089 in ?? ()
#   35.  No change no error.
#   36.  No change no error.
#   37.  No change no error.
#   38.  No change no error.
#   39.  No change no error.
#   40.  No change no error.
#   41.  No change
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18113)]
#           [New Thread 0xb1b9fb70 (LWP 18114)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 18115)]
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 18113) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb1b9fb70 (LWP 18114)]
#           0xac66008c in ?? ()
#
#   42.  No change no error.
#   43.  No change no error.
#
#   44.  Restored threads 3,4,5. No error.
#   45.  No change.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18300)]
#           [New Thread 0xb1b9fb70 (LWP 18301)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 18302)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 18303)]
#           [New Thread 0xb039fb70 (LWP 18304)]
#           [New Thread 0xafb9fb70 (LWP 18305)]
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb039fb70 (LWP 18304) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 18300) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xafb9fb70 (LWP 18305)]
#           0xad054f75 in ?? ()
#           (gdb) 
#
#   46.  No change.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18322)]
#           [New Thread 0xb1b9fb70 (LWP 18323)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 18324)]
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 18325)]
#           loop 0
#           [New Thread 0xb039fb70 (LWP 18326)]
#           [New Thread 0xafb9fb70 (LWP 18327)]
#           y: About to join subthread0y: About to joloop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb239fb70 (LWP 18322) exited]
#           y: Joined subthread0bin/mythryld: Fatal error:  bad chunk tag 21, chunk = 0xb4fea64c, tagword = 0xad546254   -- forward_agegroup0_chunk_to_agegroup1() in src/c/heapcleaner/heapclean-agegroup0.c
#           [Thread 0xafb9fb70 (LWP 18327) exited]
#           [Thread 0xb0b9fb70 (LWP 18325) exited]
#           [Thread 0xb139fb70 (LWP 18324) exited]
#           [Thread 0xb1b9fb70 (LWP 18323) exited]
#           [Thread 0xb039fb70 (LWP 18326) exited]
#           
#           Program exited with code 01.
#           (gdb) 
#
#   47.  No change.  No error.
#   48.  No change.  No error.
#   49.  No change.  No error.
#   50.  No change.  No error.
#   51.  No change.  No error.
#   52.  No change.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18485)]
#           [New Thread 0xb1b9fb70 (LWP 18486)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 18487)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 18488)]
#           [New Thread 0xb039fb70 (LWP 18489)]
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 18490)]
#           loop 0
#           loop 0
#           loop 0
#           y: About to join subthread0y: About to joloop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xafb9fb70 (LWP 18490) exited]
#           [Thread 0xb0b9fb70 (LWP 18488) exited]
#           [Thread 0xb039fb70 (LWP 18489) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 18485) exited]
#           Assertion 'all_invariants_hold map''' failed.
#           y: Joined subthread1[Thread 0xb1b9fb70 (LWP 18486) exited]
#           [Thread 0xb139fb70 (LWP 18487) exited]
#           
#           Program exited with code 01.
#
#
#   53.  No change.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18566)]
#           [New Thread 0xb1b9fb70 (LWP 18567)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 18568)]
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 18569)]
#           loop 0
#           [New Thread 0xb039fb70 (LWP 18570)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 18571)]
#           loop 0
#           y: About to join subthread0loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb1b9fb70 (LWP 18567) exited]
#           [Thread 0xb039fb70 (LWP 18570) exited]
#           y: Joined subthread0y: Joined subthread1[Thread 0xb239fb70 (LWP 18566) exited]
#           Assertion 'all_invariants_hold map''' failed.
#           [Thread 0xafb9fb70 (LWP 18571) exited]
#           [Thread 0xb0b9fb70 (LWP 18569) exited]
#           [Thread 0xb139fb70 (LWP 18568) exited]
#           
#           Program exited with code 01.
#           (gdb)
#
#   54.  Removed  threads 3,4,5.  No error.
#   55.  Restored threads 3,4,5.
#           [New Thread 0xb239fb70 (LWP 18599)]
#           [New Thread 0xb1b9fb70 (LWP 18600)]
#           [New Thread 0xb139fb70 (LWP 18601)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 18602)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb039fb70 (LWP 18603)]
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 18604)]
#           y: Abouy: About to join subthread0loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xafb9fb70 (LWP 18604) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 18599) exited]
#           bin/mythryld: Fatal error:  bad chunk tag 29, chunk = 0xb4fb5444, tagword = 0xad5563f4   -- forward_agegroup0_chunk_to_agegroup1() in src/c/heapcleaner/heapclean-agegroup0.c
#           [Thread 0xb039fb70 (LWP 18603) exited]
#           [Thread 0xb139fb70 (LWP 18601) exited]
#           [Thread 0xb1b9fb70 (LWP 18600) exited]
#           [Thread 0xb0b9fb70 (LWP 18602) exited]
#           
#           Program exited with code 01.
#           (gdb) 
#
#   56.  Removed   threads 3,4,5.  No error.
#   57.  Restored  threads 3,4,5.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18614)]
#           [New Thread 0xb1b9fb70 (LWP 18615)]
#           [New Thread 0xb139fb70 (LWP 18616)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 18617)]
#           [New Thread 0xb039fb70 (LWP 18618)]
#           loop 0
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 18619)]
#           loop 0
#           y: About to join subthread0loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb039fb70 (LWP 18618) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 18614) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb1b9fb70 (LWP 18615)]
#           0xb3419ac1 in ?? ()
#
#   58.  Removed  threads 3,4,5.  No error.
#   59   Restored threads 3,4,5.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18668)]
#           [New Thread 0xb1b9fb70 (LWP 18669)]
#           loop 0
#           loop 0
#           [New Thread 0xb139fb70 (LWP 18670)]
#           [New Thread 0xb0b9fb70 (LWP 18671)]
#           loop 0
#           [New Thread 0xb039fb70 (LWP 18672)]
#           [New Thread 0xafb9fb70 (LWP 18673)]
#           loop 0
#           loop 0
#           loop 0
#           y: About to join subthread0y: Abouy: About to joloop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xb139fb70 (LWP 18670) exited]
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 18668) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb1b9fb70 (LWP 18669)]
#           0xad5e2405 in ?? ()
#           (gdb) 
#
#   60.  Removed  threads 3,4,5.  No error.
#   61   Restored threads 3,4,5.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18772)]
#           loop 0
#           [New Thread 0xb1b9fb70 (LWP 18773)]
#           [New Thread 0xb139fb70 (LWP 18774)]
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 18772) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb1b9fb70 (LWP 18773)]
#           0x00000202 in ?? ()
#           (gdb) 
#
#   62.  Removed  threads 3,4,5.
#   63.  Restored threads 3,4,5.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18791)]
#           [New Thread 0xb1b9fb70 (LWP 18792)]
#           [New Thread 0xb139fb70 (LWP 18793)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           [New Thread 0xb0b9fb70 (LWP 18794)]
#           [New Thread 0xb039fb70 (LWP 18795)]
#           loop 0
#           [New Thread 0xafb9fb70 (LWP 18796)]
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           loop 0
#           y: About to join subthread0loop 0
#           loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           loop 4
#           [Thread 0xafb9fb70 (LWP 18796) exited]
#           [Thread 0xb1b9fb70 (LWP 18792) exited]
#           y: Joined subthread0y: Joined subthread1[Thread 0xb239fb70 (LWP 18791) exited]
#           
#           Program received signal SIGSEGV, Segmentation fault.
#           [Switching to Thread 0xb139fb70 (LWP 18793)]
#           0x08070cb9 in forward_agegroup0_chunk_to_agegroup1 (
#               ag1=<value optimized out>, v=0xb5025e5c, task=<value optimized out>, 
#               caller=0) at heapclean-agegroup0.c:530
#           530	    COPYLOOP(chunk, new_chunk, len_in_words);					// Copy over the rest of the chunk.
#
#   64.  Removed  threads 3,4,5.
#           eval:  y::run();
#           [New Thread 0xb239fb70 (LWP 18810)]
#           [New Thread 0xb1b9fb70 (LWP 18811)]
#           loop 0
#           [New Thread 0xb139fb70 (LWP 18812)]
#           y: About to join subthread0loop 0
#           loop 0
#           loop 0
#           loop 1
#           loop 1
#           loop 1
#           loop 2
#           loop 2
#           loop 2
#           loop 3
#           loop 3
#           loop 3
#           loop 3
#           loop 4
#           loop 4
#           loop 4
#           y: Joined subthread0[Thread 0xb239fb70 (LWP 18810) exited]
#           y: Joined subthread1Assertion 'all_invariants_hold map''' failed.
#           [Thread 0xb1b9fb70 (LWP 18811) exited]
#           [Thread 0xb139fb70 (LWP 18812) exited]
#           
#           Program exited with code 01.
#           (gdb) 
#
#   65.  Restored  threads 3,4,5, replaced joins by sleep.
#
################################################################
# Useful gdb commands
#     break do_breakpoint_1
#     c                       # Continue
#     s                       # single-step
#     p                       # print
#     l                       # list (sourcecode)
#     info registers
#     info all-registers
#     p/x $eax
#     p/x $pc
#     x/i $pc
#     p/x ramlog_next_entry_to_write
#     print expr              # Including fn calls.
#     call  expr              # same as above except result is not printed.
#
# package pc = mythryl_compiler::profiling_control; pc::set_compiler_to_add_per_fun_call_counters_to_deep_syntax ();
# make "y.lib";
# pc::set_compiler_to_not_add_per_fun_call_counters_to_deep_syntax (); pc::start_sigvtalrm_time_profiler ();
# y::run();
# pc::stop_sigvtalrm_time_profiler ();  pc::write_per_fun_time_profile_report  file::stdout;
# apply (fn { fun_name, call_count, cpu_seconds } = printf "Function %s was called %d times and used %g CPU seconds.\n" fun_name call_count cpu_seconds) (pc::get_per_fun_timing_stats_sorted_by_cpu_time_then_callcount ());
