<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
            "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
<HEAD>

<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<META name="GENERATOR" content="hevea 1.10">
<LINK REL=STYLESHEET type="text/css" HREF="local.css">
<LINK rel="stylesheet" type="text/css" href="book.css">
<TITLE>Multi-file Projects: Compiling a Stand-Alone Executable</TITLE>
</HEAD>
<BODY >
<A HREF="my-Multi-file_Projects__Libraries_and_API_Definitions.html"><IMG SRC="previous_motif.gif" ALT="Previous"></A><A HREF="my-Delving_Deeper.html"><IMG SRC="contents_motif.gif" ALT="Up"></A><A HREF="my-Mythryl_Backticks_Operators.html"><IMG SRC="next_motif.gif" ALT="Next"></A><HR>
<H3 CLASS="subsection"><A NAME="htoc81">5.3.16</A>  Multi-file Projects: Compiling a Stand-Alone Executable</H3><P>
<A NAME="section:tut:delving-deeper:compiling-a-stand-alone-executable"></A></P><P>To develop useful multi-file applications, you will also need to know how 
to compile a stand-alone executable which can be invoked from the 
command line or scripts like any other Linux executable.</P><P>In this section we will present a complete worked-out example of 
implementing a simple clone of the Linux <TT>factor</TT> program, 
which prints out the prime factorization of each argument it is 
given.</P><P>Our solution consists of the following four files:
</P><UL CLASS="itemize"><LI CLASS="li-itemize">
A <TT>factor.api</TT> file defining the api for the core factoring module.
</LI><LI CLASS="li-itemize">A <TT>factor.pkg</TT> file implementing the core factoring module.
</LI><LI CLASS="li-itemize">A <TT>main.pkg</TT> file implementing the Mythryl equivalent of a C <TT>main()</TT> function.
</LI><LI CLASS="li-itemize">A <TT>factor.lib</TT> makefile to drive the compilation process.
</LI></UL><P>Using these we will compile a <TT>factor</TT> executable image using 
the standard Mythryl <TT>/usr/bin/build-an-executable-mythryl-heap-image</TT> 
script which gets installed with the other standard Mythryl programs 
when you do a <TT>make install</TT>.</P><P>The following transcript shows the contents of the required files and 
also the compilation process:</P><PRE CLASS="verbatim">    linux$ cat factor.api

    api Factor {
        factors: Int -&gt; List(Int);
    };

    linux$ cat factor.pkg

    package factor {

        fun factor_helper (i, trial_divisor, known_factors) = {

            if (trial_divisor &gt; i)   reverse known_factors;
            else
                if (i % trial_divisor != 0)   factor_helper (i,               trial_divisor + 1,                  known_factors);
                else                          factor_helper (i/trial_divisor, trial_divisor,      trial_divisor ! known_factors);
                fi;
            fi;
        };

        fun factors( i ) = {
            if (i &lt;= 1)  [i];
            else         factor_helper (i, 2, []);
            fi;
        };
    };

    linux$ cat main.pkg

    package main:  api {
                       main: ((String, List( String )))   -&gt;   winix__premicrothread::process::Status;
                   }
    {
        include package   trap_control_c;         # trap_control_c        is from   src/lib/std/trap-control-c.pkg

        fun print_to_stderr msg
            =
            file::write
                (
                  file::stderr,
                  string::cat msg
                );

        fun print_factors( number, factors ) = {
            printf "%d:" number;
            map (printf " %d") factors;
            printf "\n";
        };

        fun factor_number( arg ) = {
            number = the (int::from_string arg);
            print_factors( number, factor::factors( number ) );
        };

        fun factor_args args = {
            apply factor_number args;
        };

        fun main (name, args) = {

            fun run_program ()
                =
                factor_args args;

            {   catch_interrupt_signal  run_program;
                winix__premicrothread::process::success;
            }
            except
                CONTROL_C_SIGNAL
                    =&gt;
                    {   print_to_stderr [name, ": Interrupt\n"];
                        winix__premicrothread::process::failure;
                    };

                any =&gt;
                    {   print_to_stderr [   name,
                                ": uncaught exception ",
                                exceptions::exception_message any,
                                "\n"
                            ];

                        winix__premicrothread::process::failure;
                    };
            end ;
        };
    };

    linux$ cat factor.lib

    LIBRARY_EXPORTS

            api Factor
            pkg factor
            pkg main

    LIBRARY_COMPONENTS

            $ROOT/src/lib/std/standard.lib

            factor.api
            factor.pkg

            main.pkg

    linux$ build-an-executable-mythryl-heap-image factor.lib main::main
     _build-an-executable-mythryl-heap-image:   Starting.
     _build-an-executable-mythryl-heap-image:   main=main::main (III)
     _build-an-executable-mythryl-heap-image:   main=main::main (after sed)
     _build-an-executable-mythryl-heap-image:   Listing tmp-makelib-pid-26077-export.pkg:

    pkg xyzzy_plugh { my _ = lib7::spawn_to_disk ("factor", main::main); };

     _build-an-executable-mythryl-heap-image:   Listing .lib file:

    SUBLIBRARY_EXPORTS pkg xyzzy_plugh SUBLIBRARY_COMPONENTS $ROOT/src/lib/std/standard.lib factor.lib tmp-makelib-pid-26077-export.pkg

     _build-an-executable-mythryl-heap-image:   Doing:                  "/usr/bin/mythryld"  --build-an-executable-mythryl-heap-image  "factor.lib" "tmp-makelib-pid-26077-export.lib" "factor" "tmp-makelib-pid-26077.COMPILED_FILES_TO_LOAD" "tmp-makelib-pid-26077.LINKARGS"
                parse/libfile-parser-g.pkg:   Reading   make   file   factor.lib                                            on behalf of &lt;toplevel&gt;
  app/makelib/compilable/thawedlib-tome.pkg:   Parsing   source file   factor.api
  app/makelib/compilable/thawedlib-tome.pkg:   Parsing   source file   factor.pkg
  app/makelib/compilable/thawedlib-tome.pkg:   Parsing   source file   main.pkg
          .../compile/compile-in-dependency-order-g.pkg:   Compiling source file   factor.api                                              to object file   factor.api.compiled
          .../compile/compile-in-dependency-order-g.pkg:   Compiling source file   factor.pkg                                              to object file   factor.pkg.compiled
          .../compile/compile-in-dependency-order-g.pkg:   Compiling source file   main.pkg                                                to object file   main.pkg.compiled
                parse/libfile-parser-g.pkg:   Reading   make   file   tmp-makelib-pid-26077-export.lib                        on behalf of &lt;toplevel&gt;
                parse/libfile-parser-g.pkg:   Reading   make   file   factor.lib                                            on behalf of &lt;toplevel&gt;
  app/makelib/compilable/thawedlib-tome.pkg:   Parsing   source file   tmp-makelib-pid-26077-export.pkg
          .../compile/compile-in-dependency-order-g.pkg:   Compiling source file   tmp-makelib-pid-26077-export.pkg                          to object file   tmp-makelib-pid-26077-export.pkg.compiled

              src/app/makelib/main/makelib-g.pkg:   Creating file 'tmp-makelib-pid-26077.COMPILED_FILES_TO_LOAD'


              src/app/makelib/main/makelib-g.pkg:   Creating file 'tmp-makelib-pid-26077.LINKARGS'

     _build-an-executable-mythryl-heap-image:   Doing:                        "/usr/bin/mythryl-ld" `cat "tmp-makelib-pid-26077.LINKARGS"`

    ----------------------------------------------------
                              bin/mythryl-ld:   Starting
                              bin/mythryl-ld:   Exec()'ing                              /pub/home/cynbe/src/mythryl/mythryl7/mythryl7.110.58/mythryl7.110.58/bin/mythryl-runtime-intel32 --runtime-compiledfiles-to-load=tmp-makelib-pid-26077.COMPILED_FILES_TO_LOAD --runtime-heap=mythryld 

   src/c/main/load-compiledfiles.c:   Writing load log to               mythryld-26088.load.log

   src/c/main/load-compiledfiles.c:   Reading   file          tmp-makelib-pid-26077.COMPILED_FILES_TO_LOAD

        .../lib/heap/export-fun.c:   Writing   executable (heap image) /pub/home/cynbe/src/mythryl/mythryl7/mythryl7.110.58/mythryl7.110.58/factor

    linux$ ./factor 23 24
    23: 23
    24: 2 2 2 3

    linux$
</PRE><P>The above code is largely self-explanatory; you should have little difficulty 
adapting it to your own needs.</P><P>For your convenience, the above code is shipped in the 
<TT>src/app/tut/factor/</TT> directory in the Mythryl source 
code distribution.</P><P>For a serious application, you will probably want to put the 
illustrated <TT>build-an-executable-mythryl-heap-image</TT> call 
in your application&#X2019;s Linux Makefile. (The Mythryl <TT>makelib</TT> 
is not intended to replace Linux <TT>make</TT>, but rather to 
work with it in complementary fashion. Each does well things 
the other does poorly.)</P><P>The <TT>main.pkg</TT> file is mostly boilerplate that you can use 
unchanged in your own application except for changing the 
<TT>run_program</TT> function to run the code appropriate to your 
application.</P><P>A serious application will have many more source files and perhaps 
application-specific <TT>.lib</TT> libraries. Just add them to the 
<TT>factor.lib</TT> file (presumably appropriately renamed for your 
application) and Mythryl&#X2019;s <TT>makelib</TT> will take care of compiling 
everything in the right order. (Unlike Linux <TT>make</TT>, Mythryl 
<TT>makelib</TT> deduces needed dependency relationships directly 
from the source code.)</P><P>A nontrivial application will probably support various command line 
options. You may wish to process them using the 
<A HREF="my-process_commandline.html#pkg:process_commandline">process_commandline</A> package, which is a Mythryl port of the <SPAN STYLE="font-variant:small-caps">GNU</SPAN> <TT>getopt</TT> C package.</P>

<HR SIZE=2>
<DIV CLASS="center">
<FONT SIZE=1>Comments and suggestions to: </FONT><A HREF="mailto:bugs@mythryl.org"><FONT SIZE=1>bugs@mythryl.org</FONT></A></DIV>
<HR>
<A HREF="my-Multi-file_Projects__Libraries_and_API_Definitions.html"><IMG SRC="previous_motif.gif" ALT="Previous"></A><A HREF="my-Delving_Deeper.html"><IMG SRC="contents_motif.gif" ALT="Up"></A><A HREF="my-Mythryl_Backticks_Operators.html"><IMG SRC="next_motif.gif" ALT="Next"></A></BODY>
</HTML>
