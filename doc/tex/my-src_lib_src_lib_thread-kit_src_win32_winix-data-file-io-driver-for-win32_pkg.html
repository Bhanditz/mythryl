<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
            "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
<HEAD>

<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<META name="GENERATOR" content="hevea 1.10">
<LINK REL=STYLESHEET type="text/css" HREF="local.css">
<LINK rel="stylesheet" type="text/css" href="book.css">
<TITLE>src/lib/src/lib/thread-kit/src/win32/winix-data-file-io-driver-for-win32.pkg</TITLE>
</HEAD>
<BODY >
<A HREF="my-src_lib_src_lib_thread-kit_src_process-deathwatch_pkg.html"><IMG SRC="previous_motif.gif" ALT="Previous"></A><A HREF="my-Codebase__pkg_Files.html"><IMG SRC="contents_motif.gif" ALT="Up"></A><A HREF="my-src_lib_src_list-cross-product_pkg.html"><IMG SRC="next_motif.gif" ALT="Next"></A><HR>
<H3 CLASS="subsection"><A NAME="htoc2836">15.4.948</A>  src/lib/src/lib/thread-kit/src/win32/winix-data-file-io-driver-for-win32.pkg</H3><P>
<A NAME="src/lib/src/lib/thread-kit/src/win32/winix-data-file-io-driver-for-win32.pkg"></A>
<CODE>##&nbsp;winix-data-file-io-driver-for-win32.pkg</CODE><BR><BR>
<CODE>#&nbsp;This&nbsp;may&nbsp;be&nbsp;redundant&nbsp;with</CODE><BR>
<CODE>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><A HREF="my-src_lib_std_src_posix_winix-data-file-io-driver-for-posix_pkg.html#src/lib/std/src/posix/winix-data-file-io-driver-for-posix.pkg"><TT>src/lib/std/src/posix/winix-data-file-io-driver-for-posix.pkg</TT></A><BR><BR><CODE>#&nbsp;This&nbsp;implements&nbsp;the&nbsp;Win32&nbsp;version&nbsp;of&nbsp;the&nbsp;OS&nbsp;specific&nbsp;binary&nbsp;primitive</CODE><BR>
<CODE>#&nbsp;IO&nbsp;package.&nbsp;&nbsp;The&nbsp;Text&nbsp;IO&nbsp;version&nbsp;is&nbsp;implemented&nbsp;by&nbsp;a&nbsp;trivial&nbsp;translation</CODE><BR>
<CODE>#&nbsp;of&nbsp;these&nbsp;operations&nbsp;(see&nbsp;nt-text-base-io.sml).</CODE><BR><BR>
<CODE>#&nbsp;See&nbsp;also:</CODE><BR>
<CODE>#</CODE><BR>
<CODE>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><A HREF="my-src_lib_std_src_win32_winix-data-file-io-driver-for-win32__X2013_premicrothread_pkg.html#src/lib/std/src/win32/winix-data-file-io-driver-for-win32--premicrothread.pkg"><TT>src/lib/std/src/win32/winix-data-file-io-driver-for-win32--premicrothread.pkg</TT></A><BR><BR><CODE>package&nbsp;winix_data_file_io_driver_for_win32:&nbsp;&nbsp;Winix_Base_File_Io_Driver_For_Os__Premicrothread&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;md&nbsp;=&nbsp;maildrop</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;drv&nbsp;=&nbsp;winix_base_data_file_io_driver_for_posix</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;W32FS&nbsp;=&nbsp;Win32::file_system</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;W32IO&nbsp;=&nbsp;Win32::IO</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;W32G&nbsp;=&nbsp;Win32::general</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;v&nbsp;=&nbsp;vector_of_one_byte_unts</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;File_Descriptor&nbsp;=&nbsp;W32G::hndl</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;pfi&nbsp;=&nbsp;file_position::from_int</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;pti&nbsp;=&nbsp;file_position::toInt</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;pfw&nbsp;=&nbsp;file_position::from_int&nbsp;o&nbsp;W32G::unt::toInt</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;ptw&nbsp;=&nbsp;W32G::unt::from_int&nbsp;o&nbsp;file_position::toInt</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;=&nbsp;W32G::logMsg</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;bufferSzB&nbsp;=&nbsp;4096</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;seek&nbsp;=&nbsp;pfw&nbsp;o&nbsp;W32IO::setFilePointer'</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;posFns&nbsp;iod&nbsp;=&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(winix__premicrothread::io::kind&nbsp;iod&nbsp;==&nbsp;winix__premicrothread::io::Kind::file)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;let</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my&nbsp;pos:&nbsp;&nbsp;Ref(&nbsp;&nbsp;&nbsp;file_position::Int&nbsp;)&nbsp;=&nbsp;REF&nbsp;(pfi&nbsp;0)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;getPos&nbsp;()&nbsp;:&nbsp;file_position::Int&nbsp;=&nbsp;*pos</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;setPos&nbsp;p&nbsp;=&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos&nbsp;:=&nbsp;seek&nbsp;(W32FS::IODToHndl&nbsp;iod,&nbsp;ptw&nbsp;p,&nbsp;W32IO::FILE_BEGIN)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;endPos&nbsp;()&nbsp;:&nbsp;file_position::Int&nbsp;=&nbsp;(</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;W32FS::getLowFileSize&nbsp;(W32FS::IODToHndl&nbsp;iod)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;THE&nbsp;w&nbsp;=&gt;&nbsp;pfw&nbsp;w</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE>|&nbsp;_&nbsp;=&gt;&nbsp;raise&nbsp;exception&nbsp;winix__premicrothread::RUNTIME_EXCEPTION("endPos:&nbsp;no&nbsp;file&nbsp;size",&nbsp;NULL)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;end&nbsp;case</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;verifyPos&nbsp;()&nbsp;=&nbsp;(</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos&nbsp;:=&nbsp;seek&nbsp;(W32FS::IODToHndl&nbsp;iod,&nbsp;0wx0,&nbsp;W32IO::FILE_CURRENT);</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*pos)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(verifyPos());</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;pos=pos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPos=THE&nbsp;getPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setPos=THE&nbsp;setPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;endPos=THE&nbsp;endPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyPos=THE&nbsp;verifyPos</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos=REF&nbsp;(pfi&nbsp;0),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPos=NULL,&nbsp;setPos=NULL,&nbsp;endPos=NULL,&nbsp;verifyPos=NULL</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;addCheck&nbsp;f&nbsp;(THE&nbsp;g)&nbsp;=&nbsp;THE&nbsp;(f&nbsp;g)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE>|&nbsp;addCheck&nbsp;_&nbsp;NULL&nbsp;=&nbsp;NULL</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;mkReader&nbsp;{&nbsp;fd,&nbsp;name&nbsp;}&nbsp;=&nbsp;let</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iod&nbsp;=&nbsp;W32FS::hndlToIOD&nbsp;fd</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lockMV&nbsp;=&nbsp;md::mVarInit()</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;withLock&nbsp;f&nbsp;x&nbsp;=&nbsp;(</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;md::mTake&nbsp;lockMV;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Syscall::doSyscall&nbsp;f&nbsp;x)&nbsp;then&nbsp;md::mPut&nbsp;(lockMV,&nbsp;()))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;ex&nbsp;=&gt;&nbsp;(md::mPut&nbsp;(lockMV,&nbsp;());&nbsp;raise&nbsp;exception&nbsp;ex)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;withLock'&nbsp;NULL&nbsp;=&nbsp;NULL</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE>|&nbsp;withLock'&nbsp;(THE&nbsp;f)&nbsp;=&nbsp;THE&nbsp;(withLock&nbsp;f)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;closed&nbsp;=&nbsp;REF&nbsp;FALSE</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my&nbsp;{&nbsp;pos,&nbsp;getPos,&nbsp;setPos,&nbsp;endPos,&nbsp;verifyPos&nbsp;}&nbsp;=&nbsp;posFns&nbsp;iod</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;incPos&nbsp;k&nbsp;=&nbsp;pos&nbsp;:=&nbsp;position.+(*pos,&nbsp;pfi&nbsp;k)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;blockWrap&nbsp;f&nbsp;x&nbsp;=&nbsp;(</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;*closed&nbsp;then&nbsp;raise&nbsp;exception&nbsp;io::CLOSED_IO_STREAM&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;x)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readEvt&nbsp;=</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IOManager::ioEvt&nbsp;(winix__premicrothread::io::pollIn&nbsp;(null_or::the&nbsp;(winix__premicrothread::io::pollDesc&nbsp;iod)))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;eventWrap&nbsp;f&nbsp;x&nbsp;=&nbsp;threadkit::withNack&nbsp;(\\&nbsp;nack&nbsp;=&gt;&nbsp;(</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;*closed&nbsp;then&nbsp;raise&nbsp;exception&nbsp;io::CLOSED_IO_STREAM&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;(md::mTakePoll&nbsp;lockMV)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;NULL&nbsp;=&gt;&nbsp;let</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replV&nbsp;=&nbsp;md::iVariable()</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadkit::make_thread&nbsp;"winix_base_data_file_io_driver_for_posix__premicrothread"&nbsp;(\\&nbsp;()&nbsp;=&gt;&nbsp;threadkit::do_one_mailop&nbsp;[</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadkit::wrap&nbsp;(readEvt,&nbsp;\\&nbsp;_&nbsp;=&gt;&nbsp;md::iPut&nbsp;(replV,&nbsp;())),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nack</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]);</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadkit::wrap&nbsp;(md::iGetEvt&nbsp;replV,&nbsp;\\&nbsp;_&nbsp;=&gt;&nbsp;f&nbsp;x)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE>|&nbsp;(THE&nbsp;_)&nbsp;=&gt;&nbsp;threadkit::wrap&nbsp;(readEvt,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\&nbsp;_&nbsp;=&gt;&nbsp;(md::mPut&nbsp;(lockMV,&nbsp;());&nbsp;f&nbsp;x))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;end&nbsp;case&nbsp;*/))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;readVec&nbsp;n&nbsp;=&nbsp;let</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadkit::sync&nbsp;readEvt</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;=&nbsp;W32IO::readVec&nbsp;(W32FS::IODToHndl&nbsp;iod,&nbsp;n)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incPos&nbsp;(v::length&nbsp;v);&nbsp;v</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;readArr&nbsp;arg&nbsp;=&nbsp;let</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadkit::sync&nbsp;readEvt</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k&nbsp;=&nbsp;W32IO::readArr&nbsp;(W32FS::IODToHndl&nbsp;iod,&nbsp;arg)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incPos&nbsp;k;&nbsp;k</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;close&nbsp;()&nbsp;=&nbsp;if&nbsp;*closed</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;()</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;(closed:=TRUE;&nbsp;W32IO::close&nbsp;(W32FS::IODToHndl&nbsp;iod))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;avail&nbsp;()&nbsp;=&nbsp;if&nbsp;*closed</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;THE&nbsp;0</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;(case&nbsp;W32FS::getLowFileSize&nbsp;(W32FS::IODToHndl&nbsp;iod)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;THE&nbsp;w&nbsp;=&gt;&nbsp;THE&nbsp;(position.-(pfw&nbsp;w,*pos))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE>|&nbsp;NULL&nbsp;=&gt;&nbsp;NULL</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;end&nbsp;case</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;winix_base_data_file_io_driver_for_posix::FILEREADER&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;name,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunkSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;bufferSzB,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readVec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock&nbsp;(blockWrap&nbsp;readVec),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readArr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock&nbsp;(blockWrap&nbsp;readArr),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readVecEvt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;eventWrap&nbsp;readVec,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readArrEvt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;eventWrap&nbsp;readArr,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;avail&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock&nbsp;avail,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock'&nbsp;getPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setPos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock'&nbsp;setPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;endPos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock'&nbsp;endPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyPos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock'&nbsp;verifyPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock&nbsp;close,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ioDesc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;THE&nbsp;iod</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</CODE><BR><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;shareAll&nbsp;=&nbsp;W32G::unt::bitwise_or&nbsp;(W32IO::FILE_SHARE_READ,&nbsp;W32IO::FILE_SHARE_WRITE)</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;checkHndl&nbsp;name&nbsp;h&nbsp;=&nbsp;if&nbsp;W32G::isValidHandle&nbsp;h</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;h</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;raise&nbsp;exception&nbsp;winix__premicrothread::RUNTIME_EXCEPTION("win32-binary-base-io:&nbsp;checkHndl:&nbsp;"$name$":&nbsp;failed",&nbsp;NULL)</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;openRd&nbsp;name&nbsp;=&nbsp;mkReader&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;checkHndl&nbsp;"openRd"&nbsp;(W32IO::createFile&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access=W32IO::GENERIC_READ,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;share=shareAll,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mode=W32IO::OPEN_EXISTING,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attributes=0wx0</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;name</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;mkWriter&nbsp;{&nbsp;fd,&nbsp;name,&nbsp;appendMode,&nbsp;chunkSize&nbsp;}&nbsp;=&nbsp;let</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iod&nbsp;=&nbsp;W32FS::hndlToIOD&nbsp;fd</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lockMV&nbsp;=&nbsp;md::mVarInit()</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;withLock&nbsp;f&nbsp;x&nbsp;=&nbsp;(</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;md::mTake&nbsp;lockMV;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Syscall::doSyscall&nbsp;f&nbsp;x)&nbsp;then&nbsp;md::mPut&nbsp;(lockMV,&nbsp;()))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;ex&nbsp;=&gt;&nbsp;(md::mPut&nbsp;(lockMV,&nbsp;());&nbsp;raise&nbsp;exception&nbsp;ex)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;withLock'&nbsp;NULL&nbsp;=&nbsp;NULL</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE>|&nbsp;withLock'&nbsp;(THE&nbsp;f)&nbsp;=&nbsp;THE&nbsp;(withLock&nbsp;f)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;closed&nbsp;=&nbsp;REF&nbsp;FALSE</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;ensureOpen&nbsp;()&nbsp;=&nbsp;if&nbsp;*closed&nbsp;then&nbsp;raise&nbsp;exception&nbsp;io::CLOSED_IO_STREAM&nbsp;else&nbsp;()</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;putV&nbsp;x&nbsp;=&nbsp;W32IO::writeVec&nbsp;x</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;putA&nbsp;x&nbsp;=&nbsp;W32IO::writeArr&nbsp;x</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;write&nbsp;put&nbsp;arg&nbsp;=&nbsp;(ensureOpen();&nbsp;put&nbsp;(W32FS::IODToHndl&nbsp;iod,&nbsp;arg))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writeEvt&nbsp;=</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IOManager::ioEvt&nbsp;(winix__premicrothread::io::pollOut&nbsp;(null_or::the&nbsp;(winix__premicrothread::io::pollDesc&nbsp;iod)))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;eventWrap&nbsp;f&nbsp;x&nbsp;=&nbsp;threadkit::withNack&nbsp;(\\&nbsp;nack&nbsp;=&gt;&nbsp;(</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;*closed&nbsp;then&nbsp;raise&nbsp;exception&nbsp;io::CLOSED_IO_STREAM&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;(md::mTakePoll&nbsp;lockMV)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;NULL&nbsp;=&gt;&nbsp;let</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replV&nbsp;=&nbsp;md::iVariable()</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadkit::make_thread&nbsp;"winix_base_data_file_io_driver_for_posix__premicrothread&nbsp;writer"&nbsp;(\\&nbsp;()&nbsp;=&gt;&nbsp;threadkit::do_one_mailop&nbsp;[</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadkit::wrap&nbsp;(writeEvt,&nbsp;\\&nbsp;_&nbsp;=&gt;&nbsp;md::iPut&nbsp;(replV,&nbsp;())),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nack</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]);</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threadkit::wrap&nbsp;(md::iGetEvt&nbsp;replV,&nbsp;\\&nbsp;_&nbsp;=&gt;&nbsp;f&nbsp;x)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><CODE>|&nbsp;(THE&nbsp;_)&nbsp;=&gt;&nbsp;threadkit::wrap&nbsp;(writeEvt,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\&nbsp;_&nbsp;=&gt;&nbsp;(md::mPut&nbsp;(lockMV,&nbsp;());&nbsp;f&nbsp;x))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;end&nbsp;case&nbsp;*/))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;close&nbsp;()&nbsp;=&nbsp;if&nbsp;*closed</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;()</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;(closed:=TRUE;&nbsp;W32IO::close&nbsp;(W32FS::IODToHndl&nbsp;iod))</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my&nbsp;{&nbsp;pos,&nbsp;getPos,&nbsp;setPos,&nbsp;endPos,&nbsp;verifyPos&nbsp;}&nbsp;=&nbsp;posFns&nbsp;(iod)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;winix_base_data_file_io_driver_for_posix::FILEWRITER&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;name,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunkSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;chunkSize,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writeVec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock&nbsp;(write&nbsp;putV),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writeArr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock&nbsp;(write&nbsp;putA),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writeVecEvt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;eventWrap&nbsp;(write&nbsp;putV),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writeArrEvt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;eventWrap&nbsp;(write&nbsp;putA),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getPos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock'&nbsp;getPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setPos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock'&nbsp;setPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;endPos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock'&nbsp;endPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verifyPos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock'&nbsp;verifyPos,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;withLock&nbsp;close,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ioDesc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;THE&nbsp;iod</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;openWr&nbsp;name&nbsp;=&nbsp;mkWriter&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;checkHndl&nbsp;"openWr"&nbsp;(W32IO::createFile&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access=W32IO::GENERIC_WRITE,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;share=shareAll,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mode=W32IO::CREATE_ALWAYS,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attributes=W32FS::FILE_ATTRIBUTE_NORMAL</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;),</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;name,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;appendMode&nbsp;=&nbsp;FALSE,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chunkSize&nbsp;=&nbsp;bufferSzB</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fun&nbsp;openApp&nbsp;name&nbsp;=&nbsp;let</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h&nbsp;=&nbsp;checkHndl&nbsp;"openApp"&nbsp;(W32IO::createFile&nbsp;{</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name=name,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access=W32IO::GENERIC_WRITE,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;share=shareAll,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mode=W32IO::OPEN_EXISTING,</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attributes=W32FS::FILE_ATTRIBUTE_NORMAL</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;W32IO::setFilePointer'&nbsp;(h,&nbsp;0wx0,&nbsp;W32IO::FILE_END)</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mkWriter&nbsp;{&nbsp;fd&nbsp;=&nbsp;h,&nbsp;name&nbsp;=&nbsp;name,&nbsp;appendMode&nbsp;=&nbsp;TRUE,&nbsp;chunkSize&nbsp;=&nbsp;bufferSzB&nbsp;}</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</CODE><BR><BR>
<CODE>};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;winix_data_file_io_driver_for_win32&nbsp;</CODE><BR><BR><BR>
</P>

<HR SIZE=2>
<DIV CLASS="center">
<FONT SIZE=1>Comments and suggestions to: </FONT><A HREF="mailto:bugs@mythryl.org"><FONT SIZE=1>bugs@mythryl.org</FONT></A></DIV>
<HR>
<A HREF="my-src_lib_src_lib_thread-kit_src_process-deathwatch_pkg.html"><IMG SRC="previous_motif.gif" ALT="Previous"></A><A HREF="my-Codebase__pkg_Files.html"><IMG SRC="contents_motif.gif" ALT="Up"></A><A HREF="my-src_lib_src_list-cross-product_pkg.html"><IMG SRC="next_motif.gif" ALT="Next"></A></BODY>
</HTML>
