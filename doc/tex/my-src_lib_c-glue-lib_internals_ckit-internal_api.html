<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
            "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
<HEAD>

<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<META name="GENERATOR" content="hevea 1.10">
<LINK REL=STYLESHEET type="text/css" HREF="local.css">
<LINK rel="stylesheet" type="text/css" href="book.css">
<TITLE>src/lib/c-glue-lib/internals/ckit-internal.api</TITLE>
</HEAD>
<BODY >
<A HREF="my-src_lib_c-glue-lib_c_api.html"><IMG SRC="previous_motif.gif" ALT="Previous"></A><A HREF="my-Codebase__api_Files.html"><IMG SRC="contents_motif.gif" ALT="Up"></A><A HREF="my-src_lib_c-glue-lib_ram_linkage_api.html"><IMG SRC="next_motif.gif" ALT="Next"></A><HR>
<H3 CLASS="subsection"><A NAME="htoc1123">15.3.47</A>  src/lib/c-glue-lib/internals/ckit-internal.api</H3><P>
<A NAME="src/lib/c-glue-lib/internals/ckit-internal.api"></A>
<CODE>#</CODE><BR>
<CODE>#&nbsp;A&nbsp;"private"&nbsp;extension&nbsp;to&nbsp;the&nbsp;encoding&nbsp;of&nbsp;C&nbsp;types&nbsp;in&nbsp;Mythryl.</CODE><BR>
<CODE>#&nbsp;&nbsp;&nbsp;The&nbsp;routines&nbsp;here&nbsp;are&nbsp;for&nbsp;use&nbsp;by&nbsp;code&nbsp;that&nbsp;will&nbsp;be&nbsp;automatically</CODE><BR>
<CODE>#&nbsp;&nbsp;&nbsp;generated&nbsp;from&nbsp;corresponding&nbsp;C&nbsp;files.&nbsp;&nbsp;User&nbsp;code&nbsp;is&nbsp;not&nbsp;supposed</CODE><BR>
<CODE>#&nbsp;&nbsp;&nbsp;to&nbsp;access&nbsp;them&nbsp;because&nbsp;they&nbsp;are&nbsp;unsafe.&nbsp;&nbsp;(Not&nbsp;that&nbsp;subverting&nbsp;the&nbsp;C</CODE><BR>
<CODE>#&nbsp;&nbsp;&nbsp;type&nbsp;system&nbsp;is&nbsp;a&nbsp;big&nbsp;deal!&nbsp;:)</CODE><BR>
<CODE>#</CODE><BR>
<CODE>#&nbsp;&nbsp;&nbsp;(C)&nbsp;2001,&nbsp;Lucent&nbsp;Technologies,&nbsp;Bell&nbsp;Laboratories</CODE><BR>
<CODE>#</CODE><BR>
<CODE>#&nbsp;author:&nbsp;Matthias&nbsp;Blume&nbsp;(blume@research.bell-labs.com)</CODE><BR><BR>
<CODE>#&nbsp;Compiled&nbsp;by:</CODE><BR>
<CODE>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE><A HREF="my-src_lib_c-glue-lib_internals_c-internals_lib.html#src/lib/c-glue-lib/internals/c-internals.lib"><TT>src/lib/c-glue-lib/internals/c-internals.lib</TT></A><BR><BR><CODE>api&nbsp;Ckit_Internal&nbsp;{</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;api&nbsp;Ctypes;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Ctypes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;from&nbsp;&nbsp;&nbsp;</CODE><A HREF="my-src_lib_c-glue-lib_c_api.html#src/lib/c-glue-lib/c.api"><TT>src/lib/c-glue-lib/c.api</TT></A><BR><BR><CODE>&nbsp;&nbsp;&nbsp;&nbsp;Addr&nbsp;=&nbsp;cmemory::Addr;</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Make&nbsp;struct&nbsp;or&nbsp;union&nbsp;size&nbsp;from&nbsp;its&nbsp;size&nbsp;given&nbsp;as&nbsp;a&nbsp;word.</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Needs&nbsp;explicit&nbsp;type&nbsp;constraint:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_su_size:&nbsp;&nbsp;Unt&nbsp;-&gt;&nbsp;s::Size(&nbsp;S&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Make&nbsp;struct&nbsp;or&nbsp;union&nbsp;RTTI&nbsp;given&nbsp;its&nbsp;corresponding&nbsp;size:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_su_type:&nbsp;&nbsp;s::Size&nbsp;(&nbsp;Su(&nbsp;S&nbsp;)&nbsp;)&nbsp;-&gt;&nbsp;t::Type(&nbsp;Su(&nbsp;S&nbsp;)&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Make&nbsp;function&nbsp;pointer&nbsp;type&nbsp;given&nbsp;the&nbsp;Mythryl&nbsp;function</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;that&nbsp;implements&nbsp;the&nbsp;calling&nbsp;protocol:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_fptr_type:&nbsp;&nbsp;(Addr&nbsp;-&gt;&nbsp;X&nbsp;-&gt;&nbsp;Y)&nbsp;-&gt;&nbsp;t::Type(&nbsp;Fptr&nbsp;(X&nbsp;-&gt;&nbsp;Y)&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;Make&nbsp;light-weight&nbsp;chunks:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_chunk'&nbsp;:&nbsp;Addr&nbsp;-&gt;&nbsp;Chunk'&nbsp;(T,&nbsp;C);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Make&nbsp;a&nbsp;void*&nbsp;from&nbsp;an&nbsp;address:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_voidptr:&nbsp;&nbsp;Addr&nbsp;-&gt;&nbsp;Voidptr;</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Given&nbsp;the&nbsp;function&nbsp;that&nbsp;implements&nbsp;the&nbsp;calling&nbsp;protocol</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;and&nbsp;the&nbsp;function's&nbsp;raw&nbsp;address,&nbsp;make&nbsp;a&nbsp;function&nbsp;pointer:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_fptr:&nbsp;&nbsp;((Addr&nbsp;-&gt;&nbsp;X&nbsp;-&gt;&nbsp;Y),&nbsp;Addr)&nbsp;-&gt;&nbsp;Fptr&nbsp;(X&nbsp;-&gt;&nbsp;Y);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Make&nbsp;normal&nbsp;and&nbsp;const-declared&nbsp;struct-&nbsp;or&nbsp;union-fields&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;given&nbsp;the&nbsp;field's&nbsp;type&nbsp;and&nbsp;its&nbsp;offset:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_rw_field:&nbsp;&nbsp;(t::Type(&nbsp;M&nbsp;),&nbsp;Int,&nbsp;Su_Chunk(&nbsp;S,&nbsp;C&nbsp;))&nbsp;-&gt;&nbsp;Chunk&nbsp;(M,&nbsp;C);</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_ro_field:&nbsp;&nbsp;(t::Type(&nbsp;M&nbsp;),&nbsp;Int,&nbsp;Su_Chunk(&nbsp;S,&nbsp;C&nbsp;))&nbsp;-&gt;&nbsp;Chunk&nbsp;(M,&nbsp;Ro);</CODE><BR><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Lightweight&nbsp;(no&nbsp;run-time&nbsp;type&nbsp;information)&nbsp;version:</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;NOTE:&nbsp;We&nbsp;do&nbsp;not&nbsp;pass&nbsp;RTTI&nbsp;to&nbsp;the&nbsp;light&nbsp;version&nbsp;(which&nbsp;would</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;internally&nbsp;throw&nbsp;it&nbsp;away&nbsp;anyway).&nbsp;&nbsp;This&nbsp;means&nbsp;that&nbsp;we</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;will&nbsp;need&nbsp;an&nbsp;explicit&nbsp;type&nbsp;constraint.</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_field'&nbsp;:&nbsp;(Int,&nbsp;Su_Chunk'&nbsp;(S,&nbsp;A_ac))&nbsp;-&gt;&nbsp;Chunk'&nbsp;(M,&nbsp;A_rc);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Make&nbsp;normal&nbsp;signed&nbsp;bitfields&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_rw_sbf:&nbsp;&nbsp;(Int,&nbsp;Unt,&nbsp;Unt)&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;offset&nbsp;*&nbsp;bits&nbsp;*&nbsp;shift&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Su_Chunk&nbsp;(S,&nbsp;C)&nbsp;-&gt;&nbsp;Sbf(&nbsp;C&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_ro_sbf:&nbsp;&nbsp;(Int,&nbsp;Unt,&nbsp;Unt)&nbsp;-&gt;&nbsp;#&nbsp;&nbsp;offset&nbsp;*&nbsp;bits&nbsp;*&nbsp;shift&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Su_Chunk&nbsp;(S,&nbsp;C)&nbsp;-&gt;&nbsp;Sbf(&nbsp;Ro&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Lightweight&nbsp;versions:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_rw_sbf'&nbsp;:&nbsp;(Int,&nbsp;Unt,&nbsp;Unt)&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;offset&nbsp;*&nbsp;bits&nbsp;*&nbsp;shift&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Su_Chunk'&nbsp;(S,&nbsp;C)&nbsp;-&gt;&nbsp;Sbf(&nbsp;C&nbsp;);</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_ro_sbf'&nbsp;:&nbsp;(Int,&nbsp;Unt,&nbsp;Unt)&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;offset&nbsp;*&nbsp;bits&nbsp;*&nbsp;shift&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Su_Chunk'&nbsp;(S,&nbsp;C)&nbsp;-&gt;&nbsp;Sbf(&nbsp;Ro&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Make&nbsp;normal&nbsp;unsigned&nbsp;bitfields:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_rw_ubf:&nbsp;&nbsp;(Int,&nbsp;Unt,&nbsp;Unt)&nbsp;-&gt;&nbsp;#&nbsp;&nbsp;offset&nbsp;*&nbsp;bits&nbsp;*&nbsp;shift&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Su_Chunk&nbsp;(S,&nbsp;C)&nbsp;-&gt;&nbsp;Ubf(&nbsp;C&nbsp;);</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_ro_ubf:&nbsp;&nbsp;(Int,&nbsp;Unt,&nbsp;Unt)&nbsp;-&gt;&nbsp;#&nbsp;&nbsp;offset&nbsp;*&nbsp;bits&nbsp;*&nbsp;shift&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Su_Chunk&nbsp;(S,&nbsp;C)&nbsp;-&gt;&nbsp;Ubf(&nbsp;Ro&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Lightweight&nbsp;versions:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_rw_ubf'&nbsp;:&nbsp;(Int,&nbsp;Unt,&nbsp;Unt)&nbsp;-&gt;&nbsp;#&nbsp;&nbsp;offset&nbsp;*&nbsp;bits&nbsp;*&nbsp;shift&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Su_Chunk'&nbsp;(S,&nbsp;C)&nbsp;-&gt;&nbsp;Ubf(&nbsp;C&nbsp;);</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;make_ro_ubf'&nbsp;:&nbsp;(Int,&nbsp;Unt,&nbsp;Unt)&nbsp;-&gt;&nbsp;#&nbsp;&nbsp;offset&nbsp;*&nbsp;bits&nbsp;*&nbsp;shift&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Su_Chunk'&nbsp;(S,&nbsp;C)&nbsp;-&gt;&nbsp;Ubf(&nbsp;Ro&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Reveal&nbsp;address&nbsp;behind&nbsp;void*.</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;is&nbsp;used&nbsp;to&nbsp;implement&nbsp;the&nbsp;function-call&nbsp;protocol</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;for&nbsp;functions&nbsp;that&nbsp;have&nbsp;pointer&nbsp;arguments:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;reveal:&nbsp;&nbsp;Voidptr&nbsp;-&gt;&nbsp;Addr;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;freveal:&nbsp;&nbsp;Fptr'(&nbsp;F&nbsp;)&nbsp;-&gt;&nbsp;Addr;</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;vcast:&nbsp;&nbsp;Addr&nbsp;-&gt;&nbsp;Voidptr;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;pcast:&nbsp;&nbsp;Addr&nbsp;-&gt;&nbsp;Ptr'(&nbsp;O&nbsp;);</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;fcast:&nbsp;&nbsp;Addr&nbsp;-&gt;&nbsp;Fptr'(&nbsp;F&nbsp;);</CODE><BR><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Unsafe&nbsp;low-level&nbsp;rw_vector&nbsp;subscript&nbsp;that&nbsp;does&nbsp;not&nbsp;require&nbsp;RTTI:</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;unsafe_sub:&nbsp;&nbsp;Int&nbsp;-&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;&nbsp;element&nbsp;size&nbsp;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Chunk'(&nbsp;Arr(T,&nbsp;N),&nbsp;C),&nbsp;Int)&nbsp;-&gt;</CODE><BR>
<CODE>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Chunk'&nbsp;(T,&nbsp;N);</CODE><BR>
<CODE>};</CODE><BR>
</P>

<HR SIZE=2>
<DIV CLASS="center">
<FONT SIZE=1>Comments and suggestions to: </FONT><A HREF="mailto:bugs@mythryl.org"><FONT SIZE=1>bugs@mythryl.org</FONT></A></DIV>
<HR>
<A HREF="my-src_lib_c-glue-lib_c_api.html"><IMG SRC="previous_motif.gif" ALT="Previous"></A><A HREF="my-Codebase__api_Files.html"><IMG SRC="contents_motif.gif" ALT="Up"></A><A HREF="my-src_lib_c-glue-lib_ram_linkage_api.html"><IMG SRC="next_motif.gif" ALT="Next"></A></BODY>
</HTML>
